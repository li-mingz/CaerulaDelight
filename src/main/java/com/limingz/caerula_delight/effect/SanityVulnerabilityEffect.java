package com.limingz.caerula_delight.effect;

import com.limingz.caerula_delight.registry.ModParticles;
import net.minecraft.util.Mth;
import net.minecraft.util.RandomSource;
import net.minecraft.world.effect.MobEffect;
import net.minecraft.world.effect.MobEffectCategory;
import net.minecraft.world.entity.LivingEntity;
import net.minecraft.world.level.Level;
import net.minecraft.server.level.ServerLevel;

public class SanityVulnerabilityEffect extends MobEffect {
    public SanityVulnerabilityEffect(MobEffectCategory category, int color) {
        super(category, color);
    }

    @Override
    public void applyEffectTick(LivingEntity pLivingEntity, int pAmplifier) {
        // 每 4 tick 触发一次粒子生成
        if(pLivingEntity.tickCount % 4 != 0) return;

        Level world = pLivingEntity.level();
        double x = pLivingEntity.getX();
        double y = pLivingEntity.getY();
        double z = pLivingEntity.getZ();
        double height = pLivingEntity.getBbHeight();
        double width = pLivingEntity.getBbWidth();


        if (world instanceof ServerLevel serverLevel) {
            RandomSource random = pLivingEntity.getRandom();

            double area = width * height;
            double particlesPerUnitArea = 1D; // 单位面积每次发送的粒子数量
            int maxParticles = 3; // 每次发送粒子的上限
            int count = Mth.clamp((int) Math.floor(area * particlesPerUnitArea), 1, maxParticles);
            for(int i = 0; i < count; i++){
                serverLevel.sendParticles(ModParticles.SANITY_VULNERABILITY_PARTICLE.get(),
                        x + Mth.nextDouble(random, -width, width),
                        y + Mth.nextDouble(random, 0.0D, height * 0.6D),
                        z + Mth.nextDouble(random, -width, width),
                        0,
                        Mth.nextDouble(random, -0.05D, 0.05D), // 随机X速度
                        0.05D, // 稍微向上的Y速度
                        Mth.nextDouble(random, -0.05D, 0.05D), // 随机Z速度
                        1.0);
            }
        }
    }

    @Override
    public boolean isDurationEffectTick(int pDuration, int pAmplifier) {
        return true;
    }
}
